#target "illustrator"#include "funcs.jsx"app.coordinateSystem = CoordinateSystem.ARTBOARDCOORDINATESYSTEM;var stateFunc=false;var target;var lowBoxCtategory;var lowBoxBottom;var isNoCategory = false;var isNoNumber = false;var MakeInfo={    isPre:false,     isAfter:false,     isTitleMulti:false,    isPreMulti:false,    isAfterMulti:false,    isEijiTitle:false};function moveAreaText(obj,box,isUp){    var objWideHalf = obj.width / 2;    var geoObj = obj.geometricBounds;    var rcWideHalf = (box[2] - box[0]) / 2;    var dx,dy;    if(isUp){        if(isNoCategory){            rcWideHalf = ((box[2]+14) - (box[0]+14)) / 2;        }                if(rcWideHalf*2 < obj.width){            dx = box[0];        }        else{            dx = box[0] + (rcWideHalf - objWideHalf);        }                dy = box[3] + geoObj[3];    }    else{        if(isNoCategory){            dx = box[0] + (rcWideHalf - objWideHalf)+((lowBoxCtategory[2]-lowBoxCtategory[0])/2) - 1;        }else{            dx = box[0] + (rcWideHalf - objWideHalf);        }        dy = box[1] + geoObj[1];    }    obj.translate(dx ,-dy);}function makeTitleText(preSub,title,afterSub,box,isUp){    var maxHorg = box[3] - box[1];    var maxH = maxHorg;    var maxW = box[2] - box[0];    var titleQ = defQ;    var preQ=defSubQ;    var afterQ=defSubQ;    var space;        var selObj = getSelectItems(lowBoxCtategory);    if(selObj.length == 0){        //カテゴリなし        maxW = lowBoxCtategory[2] - box[0];        isNoCategory = true;    }else{        deselectObjs(selObj);    }    if(isUp){        space=mmToPt(tumeUpper);        maxW = (box[2]+10) - box[0];        maxH = maxHorg - 1.5;    }else{        space=mmToPt(tumeLower);        selObj = getSelectItems(lowBoxBottom);        if(selObj.length == 0){            //下部ナンバーなし            isNoNumber = true;            maxH =maxHorg -1;        }else{            deselectObjs(selObj);            maxH =maxHorg-12;        }    }                var TitleObj = null;    var maxHtmp = (MakeInfo.isEijiTitle)?maxW:maxH;    var maxWtmp = (MakeInfo.isEijiTitle)?maxH:maxW;    var afterSubtmp = afterSub;    var preSubtmp = title;    var tmpTitle="";        if(!MakeInfo.isPre && !MakeInfo.isAfter){ // サブなし        if(!MakeInfo.isTitleMulti){ // 分割なし            titleQ = decideMainQ(title, maxH, titleQ, MakeInfo.isEijiTitle);            var Qs = decideTotalQ(titleQ,preQ,maxW,space,MakeInfo);            var rc = (MakeInfo.isEijiTitle)?[0,0,maxWtmp,Qs[2]]:[0,0,Qs[2],maxHtmp];            TitleObj = makeAreaText(title, Qs[0], rc, space, MakeInfo.isEijiTitle);        }else{            var sptTitle = splitText(title);            sptTitle[0] = trimStr(sptTitle[0]);            sptTitle[1] = trimStr(sptTitle[1]);            var longerStr = (sptTitle[0].length > sptTitle[1].length)? sptTitle[0]:sptTitle[1];            titleQ = decideMainQ(longerStr, maxH, titleQ, MakeInfo.isEijiTitle);            var Qs = decideTotalQ(titleQ,preQ,maxW,space,MakeInfo);            var rc = (MakeInfo.isEijiTitle)?[0,0,maxWtmp,Qs[2]]:[0,0,Qs[2],maxHtmp];            TitleObj = makeAreaText(sptTitle[0]+"\n"+sptTitle[1], Qs[0], rc, space, MakeInfo.isEijiTitle);        }    }else{        if(MakeInfo.isPre && MakeInfo.isAfter){ // 前、タイトル、後            var sptPre = null;            var sptAfter = null;            var sptTitle = null;            var titleOfst=afterSub.length + title.length + 1;            var subOfst=afterSub.length;            var longerSubStr = (preSub.length > afterSub.length)? preSub:afterSub;            var shorterSubStr = (preSub.length > afterSub.length)? afterSub:preSub;            if(MakeInfo.isPreMulti){                space/=2;                space*=henbaiRitu;                sptPre = splitTextString(preSub);                sptPre[0] = trimStr(sptPre[0]);                sptPre[1] = trimStr(sptPre[1]);                var longerStr = (sptPre[0].length > sptPre[1].length)? sptPre[0]:sptPre[1];                longerStr = (longerStr.length > shorterSubStr.length)? longerStr:shorterSubStr;                preQ = decideMainQ(longerStr, maxH, preQ, MakeInfo.isEijiTitle);                tmpTitle = sptPre[0]+"\n"+sptPre[1] + '\n' + title+"\n"+afterSub;            }            else if(MakeInfo.isAfterMulti){                space/=2;                space*=henbaiRitu;                sptAfter = splitTextString(afterSub);                sptAfter[0] = trimStr(sptAfter[0]);                sptAfter[1] = trimStr(sptAfter[1]);                var longerStr = (sptAfter[0].length > sptAfter[1].length)? sptAfter[0]:sptAfter[1];                longerStr = (longerStr.length > shorterSubStr.length)? longerStr:shorterSubStr;                preQ = decideMainQ(longerStr, maxH, preQ, MakeInfo.isEijiTitle);                tmpTitle = preSub+"\n"+title + '\n' + sptAfter[0]+"\n"+sptAfter[1];                titleOfst=afterSub.length + title.length + 2;                subOfst+=1;            }            else{                preQ = decideMainQ(longerSubStr, maxH, preQ, MakeInfo.isEijiTitle);            }                        if(MakeInfo.isTitleMulti){                space/=2;                space*=henbaiRitu;                sptTitle = splitTextString(title);                sptTitle[0] = trimStr(sptTitle[0]);                sptTitle[1] = trimStr(sptTitle[1]);                longerStr = (sptTitle[0].length > sptTitle[1].length)? sptTitle[0]:sptTitle[1];                titleQ = decideMainQ(longerStr, maxH, titleQ, MakeInfo.isEijiTitle);                tmpTitle = preSub+"\n"+sptTitle[0] + '\n' + sptTitle[1]+"\n"+afterSub;                titleOfst=afterSub.length + title.length + 2;            }            else{                titleQ = decideMainQ(title, maxH, titleQ, MakeInfo.isEijiTitle);                if(tmpTitle=="") tmpTitle = preSub+"\n"+title+'\n'+afterSub;            }                        if(preQ > titleQ) preQ = titleQ - 1;            var Qs = decideTotalQ(titleQ,preQ,maxW,space,MakeInfo);            var rc = (MakeInfo.isEijiTitle)?[0,0,maxWtmp,Qs[2]]:[0,0,Qs[2],maxHtmp];            TitleObj = makeAreaText(tmpTitle, Qs[1], rc, space, MakeInfo.isEijiTitle);                        for(var i=(TitleObj.characters.length - titleOfst); i<(TitleObj.characters.length - subOfst); i++){                targetChar = TitleObj.characters[i];                var leading = mmToPt(Qtomm(Qs[0])) + space;                targetChar.characterAttributes.leading = leading;                 targetChar.characterAttributes.size = mmToPt(Qtomm(Qs[0]));            }        }        else if(MakeInfo.isPre){ // 前サブ            var sptPre = null;            var sptTitle = null;            if(MakeInfo.isPreMulti && MakeInfo.isTitleMulti){ // 両方分割                space/=2;                space*=henbaiRitu;                sptPre = splitTextString(preSub);                sptPre[0] = trimStr(sptPre[0]);                sptPre[1] = trimStr(sptPre[1]);                var longerStr = (sptPre[0].length > sptPre[1].length)? sptPre[0]:sptPre[1];                preQ = decideMainQ(longerStr, maxH, preQ, MakeInfo.isEijiTitle);                                sptTitle = splitTextString(title);                sptTitle[0] = trimStr(sptTitle[0]);                sptTitle[1] = trimStr(sptTitle[1]);                longerStr = (sptTitle[0].length > sptTitle[1].length)? sptTitle[0]:sptTitle[1];                titleQ = decideMainQ(longerStr, maxH, titleQ, MakeInfo.isEijiTitle);                tmpTitle = sptPre[0]+"\n"+sptPre[1] + '\n' + sptTitle[0]+"\n"+sptTitle[1];            }            else if(!MakeInfo.isPreMulti && !MakeInfo.isTitleMulti){ // 両方分割なし                preQ = decideMainQ(preSub, maxH, preQ, MakeInfo.isEijiTitle);                titleQ = decideMainQ(title, maxH, titleQ, MakeInfo.isEijiTitle);                tmpTitle = preSub+"\n"+title;            }            else if(!MakeInfo.isPreMulti && MakeInfo.isTitleMulti){// タイトルのみ分割                sptTitle = splitText(title);                sptTitle[0] = trimStr(sptTitle[0]);                sptTitle[1] = trimStr(sptTitle[1]);                var longerStr = (sptTitle[0].length > sptTitle[1].length)? sptTitle[0]:sptTitle[1];                titleQ = decideMainQ(longerStr, maxH, titleQ, MakeInfo.isEijiTitle);                preQ = decideMainQ(preSub, maxH, preQ, MakeInfo.isEijiTitle);                tmpTitle = preSub+"\n"+sptTitle[0]+"\n"+sptTitle[1];                preSubtmp += "\n";            }            else if(MakeInfo.isPreMulti && !MakeInfo.isTitleMulti){// サブのみ分割                titleQ = decideMainQ(title, maxH, titleQ, MakeInfo.isEijiTitle);                sptPre = splitText(preSub);                sptPre[0] = trimStr(sptPre[0]);                sptPre[1] = trimStr(sptPre[1]);                var longerStr = (sptPre[0].length > sptPre[1].length)? sptPre[0]:sptPre[1];                preQ = decideMainQ(longerStr, maxH, preQ, MakeInfo.isEijiTitle);                tmpTitle = sptPre[0]+"\n"+sptPre[1]+"\n"+title;            }            var Qs = decideTotalQ(titleQ,preQ,maxW,space,MakeInfo);            var rc = (MakeInfo.isEijiTitle)?[0,0,maxWtmp,maxW]:[0,0,maxW,maxHtmp];            if(MakeInfo.isPreMulti && MakeInfo.isTitleMulti){                TitleObj = makeAreaText(tmpTitle, Qs[0], rc, space, MakeInfo.isEijiTitle);                adjustSubSize4(TitleObj, sptTitle, sptPre, Qs[1], space, true);            }else{                TitleObj = makeAreaText(tmpTitle, Qs[1], rc, space, MakeInfo.isEijiTitle);                adjustSubSize(TitleObj, preSubtmp, Qs[0], space);            }                    }else if(MakeInfo.isAfter){            var sptAfter = null;            var sptTitle = null;            if(MakeInfo.isAfterMulti && MakeInfo.isTitleMulti){ // 両方分割                space/=2;                space*=henbaiRitu;                sptAfter = splitTextString(afterSub);                sptAfter[0] = trimStr(sptAfter[0]);                sptAfter[1] = trimStr(sptAfter[1]);                var longerStr = (sptAfter[0].length > sptAfter[1].length)? sptAfter[0]:sptAfter[1];                afterQ = decideMainQ(longerStr, maxH, afterQ, MakeInfo.isEijiTitle);                                sptTitle = splitTextString(title);                sptTitle[0] = trimStr(sptTitle[0]);                sptTitle[1] = trimStr(sptTitle[1]);                longerStr = (sptTitle[0].length > sptTitle[1].length)? sptTitle[0]:sptTitle[1];                titleQ = decideMainQ(longerStr, maxH, titleQ, MakeInfo.isEijiTitle);                tmpTitle = sptTitle[0]+"\n"+sptTitle[1] + '\n' + sptAfter[0]+"\n"+sptAfter[1];            }            else if(!MakeInfo.isAfterMulti && !MakeInfo.isTitleMulti){ // 両方分割なし                afterQ = decideMainQ(afterSub, maxH, afterQ, MakeInfo.isEijiTitle);                titleQ = decideMainQ(title, maxH, titleQ, MakeInfo.isEijiTitle);                tmpTitle = title+"\n"+afterSub;            }else if(!MakeInfo.isAfterMulti && MakeInfo.isTitleMulti){// タイトルのみ分割                var sptTitle = splitText(title);                sptTitle[0] = trimStr(sptTitle[0]);                sptTitle[1] = trimStr(sptTitle[1]);                var longerStr = (sptTitle[0].length > sptTitle[1].length)? sptTitle[0]:sptTitle[1];                titleQ = decideMainQ(longerStr, maxH, titleQ, MakeInfo.isEijiTitle);                afterQ = decideMainQ(afterSub, maxH, afterQ, MakeInfo.isEijiTitle);                tmpTitle = sptTitle[0]+"\n"+sptTitle[1]+"\n"+afterSub;            }            else if(MakeInfo.isAfterMulti && !MakeInfo.isTitleMulti){// サブのみ分割                                titleQ = decideMainQ(title, maxH, titleQ, MakeInfo.isEijiTitle);                var sptAfter = splitText(afterSub);                sptAfter[0] = trimStr(sptAfter[0]);                sptAfter[1] = trimStr(sptAfter[1]);                var longerStr = (sptAfter[0].length > sptAfter[1].length)? sptAfter[0]:sptAfter[1];                afterQ = decideMainQ(longerStr, maxH, afterQ, MakeInfo.isEijiTitle);                afterSubtmp += "\n";                tmpTitle = title+"\n"+sptAfter[0]+"\n"+sptAfter[1];            }            var Qs = decideTotalQ(titleQ,afterQ,maxW,space,MakeInfo);            var rc = (MakeInfo.isEijiTitle)?[0,0,maxWtmp,maxW]:[0,0,maxW,maxHtmp];            TitleObj = makeAreaText(tmpTitle, Qs[0], rc, space, MakeInfo.isEijiTitle);            if(MakeInfo.isAfterMulti && MakeInfo.isTitleMulti){                adjustSubSize4(TitleObj, sptTitle, sptAfter, Qs[1], space, false);            }else{                adjustSubSize(TitleObj, afterSubtmp, Qs[1], space);            }        }    }    /*if(checkOverflowTextArea(TitleObj)){        expandAreaText(TitleObj);    }*/    fitAreaTextWidth(TitleObj,MakeInfo.isEijiTitle);    if(isUp) TitleObj.rotate(180);    return TitleObj;}// 書名書き込み条件設定function decideMakeMode(preSub,title,afterSub){    // 前サブが存在するか    MakeInfo.isPre=(preSub=="")?false:true;    // 後サブが存在するか    MakeInfo.isAfter=(afterSub=="")?false:true;        var maxLength = 0;    var mostLengthTitle = "";    if(MakeInfo.isPre && isOverText(preSub,multiLineBorder_Sub)){        maxLength = preSub.length;        mostLengthTitle = preSub;    }    if(isOverText(title,multiLineBorder_Title)){        if(maxLength < title.length){            maxLength = title.length;            mostLengthTitle = title;        }    }    if(MakeInfo.isAfter && isOverText(afterSub,multiLineBorder_Sub)){        if(maxLength < afterSub.length){            maxLength = afterSub.length;            mostLengthTitle =afterSub;        }    }        if(preSub!="" && afterSub!=""){        if(isOverText(title,multiLineBorder_Title) && isOverText(preSub,multiLineBorder_Sub) && isOverText(afterSub,multiLineBorder_Sub)){            var longerSub= (preSub.length > afterSub.length)? preSub:afterSub;            var longerStr = (title.length > longerSub.length)?title:longerSub;            if(longerStr==longerSub){                if(longerSub==preSub){                    MakeInfo.isTitleMulti=false;                    MakeInfo.isPreMulti = true;                    MakeInfo.isAfterMulti = false;                }                else if(longerSub==afterSub){                    MakeInfo.isTitleMulti=false;                    MakeInfo.isPreMulti = false;                    MakeInfo.isAfterMulti = true;                }            }else{                    MakeInfo.isTitleMulti=true;                    MakeInfo.isPreMulti = false;                    MakeInfo.isAfterMulti = false;            }        }        else if(isOverText(preSub,multiLineBorder_Sub) && isOverText(afterSub,multiLineBorder_Sub)){            var longerStr = (preSub.length > afterSub.length)? preSub:afterSub;            if(longerStr==preSub){                MakeInfo.isTitleMulti=false;                MakeInfo.isPreMulti = true;                MakeInfo.isAfterMulti = false;            }else if(longerStr==afterSub){                MakeInfo.isTitleMulti=false;                MakeInfo.isPreMulti = false;                MakeInfo.isAfterMulti = true;            }        }        else if(isOverText(preSub,multiLineBorder_Sub)){            MakeInfo.isTitleMulti=false;            MakeInfo.isPreMulti = true;            MakeInfo.isAfterMulti = false;        }        else if(isOverText(afterSub,multiLineBorder_Sub)){            MakeInfo.isTitleMulti=false;            MakeInfo.isPreMulti = false;            MakeInfo.isAfterMulti = true;        }        else if(isOverText(title,multiLineBorder_Title)){            MakeInfo.isTitleMulti=true;            MakeInfo.isPreMulti = false;            MakeInfo.isAfterMulti = false;        }        else{            MakeInfo.isTitleMulti=false;            MakeInfo.isPreMulti = false;            MakeInfo.isAfterMulti = false;        }    }    // タイトル長い    else if(mostLengthTitle==title && maxLength!=0){        var spt = splitText(title);        var lenDiff= spt[0].length - spt[1].length;        var shorterLength= (spt[0].length < spt[1].length)?spt[0].length:spt[1].length;        if(shorterLength <= lenDiffBorder){            MakeInfo.isTitleMulti=false;            MakeInfo.isPreMulti = false;            MakeInfo.isAfterMulti = false;        }else{            MakeInfo.isTitleMulti=true;            MakeInfo.isPreMulti = false;            MakeInfo.isAfterMulti = false;        }    }    // 前サブ長い    else if(mostLengthTitle==preSub && maxLength!=0){        var spt = splitText(preSub);        var lenDiff= spt[0].length - spt[1].length;        var shorterLength= (spt[0].length < spt[1].length)?spt[0].length:spt[1].length;        if(shorterLength <= lenDiffBorder){            MakeInfo.isTitleMulti=false;            MakeInfo.isPreMulti = false;            MakeInfo.isAfterMulti = false;        }else{            MakeInfo.isTitleMulti=false;            MakeInfo.isPreMulti = true;            MakeInfo.isAfterMulti = false;        }    }    // 後サブ長い    else if(mostLengthTitle==afterSub && maxLength!=0){        var spt = splitText(afterSub);        var lenDiff= spt[0].length - spt[1].length;        var shorterLength= (spt[0].length < spt[1].length)?spt[0].length:spt[1].length;        if(shorterLength <= lenDiffBorder){            MakeInfo.isTitleMulti=false;            MakeInfo.isPreMulti = false;            MakeInfo.isAfterMulti = false;        }else{            MakeInfo.isTitleMulti=false;            MakeInfo.isPreMulti = false;            MakeInfo.isAfterMulti = true;        }    }    // 長いのない    else if(mostLengthTitle==""){        MakeInfo.isTitleMulti=false;        MakeInfo.isPreMulti = false;        MakeInfo.isAfterMulti = false;    }    else if (isOverText(preSub,multiLineBorder_Sub) && isOverText(title,multiLineBorder_Title)){        MakeInfo.isTitleMulti=true;        MakeInfo.isPreMulti = true;        MakeInfo.isAfterMulti = false;    }    else if (isOverText(afterSub,multiLineBorder_Sub) && isOverText(title,multiLineBorder_Title)){        MakeInfo.isTitleMulti=true;        MakeInfo.isPreMulti = false;        MakeInfo.isAfterMulti = true;    }    // ローマ数字を除いて、英字があるか    var tmpTotal="";    var tmpPre=checkParlenNum(preSub);    var tmpTitle=checkParlenNum(title);    var tmpAfter=checkParlenNum(afterSub);    tmpTotal = tmpPre+tmpTitle+tmpAfter;    MakeInfo.isEijiTitle = (tmpTotal.match (/[a-z]/i))?true:false;}try{    rurerOrigin();    var title,preSub,afterSub;    var upbox,dwbox;    if(DebugScript){        preSub = "";//        title = "Fate/Grand Order 電撃コミックアンソロジー16";        afterSub ="";                title="100年後も読まれる名作(11) オズの魔法使い";        upbox = [279.63574218750, 97.34130859375,  311.19921875000,  326.67333984375];        dwbox = [302.87207031250, 522.43115234375, 325.68261718750,742.07763671875];        lowBoxCtategory = [325.68261718750, 510.59228515625, 335.455078125, 742.07763671875];        lowBoxBottom = [302.8720703125, 742.07763671875 - 10, 335.455078125, 742.07763671875];    }else{        preSub      = arguments[0];        title           = arguments[1];        afterSub    = arguments[2];        upbox       = [arguments[3],arguments[4]+2,arguments[5],arguments[6]];        dwbox       = [arguments[7],arguments[8],arguments[9],arguments[10]];        lowBoxCtategory = [arguments[9],arguments[11],arguments[12],arguments[10]];        lowBoxBottom = [arguments[7], arguments[10]-10,arguments[12],arguments[10]];    }    if(title==""){    }else{        decideMakeMode(preSub,title,afterSub);        /*var trPre = trimParlen(preSub);        var trTit = trimParlen(title);        var trAft = trimParlen(afterSub);        var upTxt = makeTitleText(trPre,trTit,trAft,upbox,true);        moveAreaText(upTxt,upbox,true);        var dwTxt = makeTitleText(trPre,trTit,trAft,dwbox,false);        moveAreaText(dwTxt,dwbox,false);*/        var upTxt = makeTitleText(preSub,title,afterSub,upbox,true);        moveAreaText(upTxt,upbox,true);        var dwTxt = makeTitleText(preSub,title,afterSub,dwbox,false);        moveAreaText(dwTxt,dwbox,false);    }}catch(e){    stateFunc=true;}if(stateFunc) "NG";else "OK";